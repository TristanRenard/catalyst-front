import { useState } from 'react'
import { useNavigate } from 'react-router'
import { useWebSocket } from '~/hooks/useWebsocket'
import { useSession } from '~/hooks/useSession'
import type {
  MatchFoundPayload,
  MatchStartPayload,
  PrivateRoomCreatedPayload,
  PrivateRoomJoinedPayload,
  QueueJoinedPayload,
  WaitingForOpponentPayload,
} from '~/types/socket'

type LobbyState = 'idle' | 'in_queue' | 'waiting_private' | 'in_private_room' | 'match_found'

export default function LobbyPage() {
  const navigate = useNavigate()
  const [lobbyState, setLobbyState] = useState<LobbyState>('idle')
  const [queueSize, setQueueSize] = useState(0)
  const [privateRoomCode, setPrivateRoomCode] = useState('')
  const [joinRoomCode, setJoinRoomCode] = useState('')
  const [opponent, setOpponent] = useState<{ id: string; username: string } | null>(null)
  const [error, setError] = useState<string | null>(null)

  // R√©cup√©rer la session utilisateur
  const { sessionToken, user, isLoading: isLoadingSession } = useSession()
  const username = user?.username

  const {
    isConnected,
    joinQueue,
    leaveQueue,
    createPrivateRoom,
    joinPrivateRoom,
    leavePrivateRoom,
    connectionState,
  } = useWebSocket({
    url: import.meta.env.VITE_WS_URL || 'ws://localhost:5173/ws',
    token: sessionToken || '',
    autoConnect: !!sessionToken,
    handlers: {
      onQueueJoined: (payload: QueueJoinedPayload) => {
        console.log('File rejointe:', payload)
        setLobbyState('in_queue')
        setQueueSize(payload.queueSize)
        setError(null)
      },
      onQueueLeft: () => {
        console.log('File quitt√©e')
        setLobbyState('idle')
        setQueueSize(0)
      },
      onMatchFound: (payload: MatchFoundPayload) => {
        console.log('Match trouv√©:', payload)
        setLobbyState('match_found')
        setOpponent(payload.opponent)
      },
      onMatchStart: (payload: MatchStartPayload) => {
        console.log('Match d√©marr√©:', payload)
        // Rediriger vers la page de jeu
        navigate('/game')
      },
      onPrivateRoomCreated: (payload: PrivateRoomCreatedPayload) => {
        console.log('Salle priv√©e cr√©√©e:', payload)
        setPrivateRoomCode(payload.roomCode)
        setLobbyState('waiting_private')
        setError(null)
      },
      onPrivateRoomJoined: (payload: PrivateRoomJoinedPayload) => {
        console.log('Salle priv√©e rejointe:', payload)
        setPrivateRoomCode(payload.roomCode)
        setOpponent(payload.host)
        setLobbyState('in_private_room')
        setError(null)
      },
      onWaitingForOpponent: (payload: WaitingForOpponentPayload) => {
        console.log('En attente d\'adversaire:', payload)
        setLobbyState('waiting_private')
      },
      onError: (payload) => {
        console.error('Erreur:', payload)
        setError(payload.message)
        setTimeout(() => setError(null), 5000)
      },
    },
  })

  // Rediriger vers login si pas de token
  useEffect(() => {
    if (!token) {
      navigate('/auth/login')
    }
  }, [token, navigate])

  const handleJoinQueue = () => {
    joinQueue()
  }

  const handleLeaveQueue = () => {
    leaveQueue()
  }

  const handleCreatePrivateRoom = () => {
    createPrivateRoom()
  }

  const handleJoinPrivateRoom = () => {
    if (!joinRoomCode.trim()) {
      setError('Veuillez entrer un code de salle')
      return
    }
    joinPrivateRoom(joinRoomCode.trim())
  }

  const handleLeavePrivateRoom = () => {
    leavePrivateRoom()
    setLobbyState('idle')
    setPrivateRoomCode('')
    setOpponent(null)
  }

  const handleCopyRoomCode = () => {
    navigator.clipboard.writeText(privateRoomCode)
    alert('Code copi√© dans le presse-papier !')
  }

  if (!isConnected) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 flex items-center justify-center">
        <div className="bg-white/10 backdrop-blur-md rounded-xl p-8 shadow-2xl">
          <div className="text-white text-center">
            <div className="text-xl mb-4">Connexion au serveur...</div>
            <div className="text-sm opacity-75">{connectionState}</div>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 p-8">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          <h1 className="text-5xl font-bold text-white mb-2">Catalyst</h1>
          <p className="text-white/80">
            Bienvenue, <span className="font-bold">{username}</span>
          </p>
        </div>

        {/* Error Message */}
        {error && (
          <div className="bg-red-500/20 border-2 border-red-500 text-white p-4 rounded-lg mb-6 text-center">
            ‚ùå {error}
          </div>
        )}

        {/* Idle State */}
        {lobbyState === 'idle' && (
          <div className="space-y-6">
            {/* Quick Match */}
            <div className="bg-white/10 backdrop-blur-md rounded-xl p-8 shadow-2xl">
              <h2 className="text-2xl font-bold text-white mb-4">üéÆ Partie Rapide</h2>
              <p className="text-white/80 mb-6">
                Rejoignez la file d'attente pour trouver un adversaire automatiquement
              </p>
              <button
                onClick={handleJoinQueue}
                className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition text-lg"
              >
                Rejoindre la file d'attente
              </button>
            </div>

            {/* Private Room */}
            <div className="bg-white/10 backdrop-blur-md rounded-xl p-8 shadow-2xl">
              <h2 className="text-2xl font-bold text-white mb-4">üîí Partie Priv√©e</h2>

              {/* Create Room */}
              <div className="mb-6">
                <h3 className="text-lg font-semibold text-white mb-2">Cr√©er une salle</h3>
                <p className="text-white/80 mb-4 text-sm">
                  Cr√©ez une salle priv√©e et partagez le code avec un ami
                </p>
                <button
                  onClick={handleCreatePrivateRoom}
                  className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition"
                >
                  Cr√©er une salle priv√©e
                </button>
              </div>

              {/* Join Room */}
              <div>
                <h3 className="text-lg font-semibold text-white mb-2">Rejoindre une salle</h3>
                <p className="text-white/80 mb-4 text-sm">
                  Entrez le code de la salle pour rejoindre votre ami
                </p>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={joinRoomCode}
                    onChange={(e) => setJoinRoomCode(e.target.value.toUpperCase())}
                    placeholder="CODE DE SALLE"
                    className="flex-1 bg-white/20 text-white placeholder-white/50 px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    maxLength={6}
                  />
                  <button
                    onClick={handleJoinPrivateRoom}
                    className="bg-purple-600 hover:bg-purple-700 text-white font-bold px-6 rounded-lg transition"
                  >
                    Rejoindre
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* In Queue */}
        {lobbyState === 'in_queue' && (
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-8 shadow-2xl">
            <div className="text-center">
              <div className="text-white text-2xl font-bold mb-4">
                üîç Recherche d'adversaire...
              </div>
              <div className="text-white/80 mb-6">
                Joueurs dans la file : {queueSize}
              </div>
              <div className="mb-6">
                <div className="w-16 h-16 border-4 border-white/30 border-t-white rounded-full animate-spin mx-auto"></div>
              </div>
              <button
                onClick={handleLeaveQueue}
                className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition"
              >
                Quitter la file
              </button>
            </div>
          </div>
        )}

        {/* Waiting for opponent in private room */}
        {lobbyState === 'waiting_private' && (
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-8 shadow-2xl">
            <div className="text-center">
              <div className="text-white text-2xl font-bold mb-4">
                üîí Salle priv√©e cr√©√©e
              </div>
              <div className="text-white/80 mb-4">
                Partagez ce code avec votre ami pour qu'il puisse rejoindre :
              </div>
              <div className="bg-white/20 rounded-lg p-6 mb-6">
                <div className="text-white text-4xl font-bold tracking-widest mb-2">
                  {privateRoomCode}
                </div>
                <button
                  onClick={handleCopyRoomCode}
                  className="text-blue-300 hover:text-blue-200 text-sm underline"
                >
                  üìã Copier le code
                </button>
              </div>
              <div className="text-white/80 mb-6">
                ‚è≥ En attente d'un adversaire...
              </div>
              <button
                onClick={handleLeavePrivateRoom}
                className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition"
              >
                Annuler
              </button>
            </div>
          </div>
        )}

        {/* In private room with opponent */}
        {lobbyState === 'in_private_room' && opponent && (
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-8 shadow-2xl">
            <div className="text-center">
              <div className="text-white text-2xl font-bold mb-4">
                üéÆ Pr√™t √† jouer !
              </div>
              <div className="text-white/80 mb-6">
                Salle : <span className="font-bold">{privateRoomCode}</span>
              </div>
              <div className="bg-white/20 rounded-lg p-6 mb-6">
                <div className="text-white/60 text-sm mb-2">Adversaire</div>
                <div className="text-white text-xl font-bold">{opponent.username}</div>
              </div>
              <div className="text-white/80 mb-6">
                La partie va d√©marrer automatiquement...
              </div>
              <button
                onClick={handleLeavePrivateRoom}
                className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition"
              >
                Quitter la salle
              </button>
            </div>
          </div>
        )}

        {/* Match Found */}
        {lobbyState === 'match_found' && opponent && (
          <div className="bg-white/10 backdrop-blur-md rounded-xl p-8 shadow-2xl">
            <div className="text-center">
              <div className="text-white text-2xl font-bold mb-4">
                ‚úÖ Adversaire trouv√© !
              </div>
              <div className="bg-white/20 rounded-lg p-6 mb-6">
                <div className="text-white/60 text-sm mb-2">Vous allez affronter</div>
                <div className="text-white text-xl font-bold">{opponent.username}</div>
              </div>
              <div className="text-white/80 mb-6">
                La partie va d√©marrer dans quelques secondes...
              </div>
            </div>
          </div>
        )}

        {/* Back to home */}
        <div className="text-center mt-8">
          <button
            onClick={() => navigate('/')}
            className="text-white/60 hover:text-white transition"
          >
            ‚Üê Retour √† l'accueil
          </button>
        </div>
      </div>
    </div>
  )
}
